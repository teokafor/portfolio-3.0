let objs=[[{x:191,y:192,size:11},{x:180,y:175,size:7},{x:174,y:204,size:7},{x:182,y:223,size:7},{x:202,y:231,size:7},{x:203,y:210,size:7},{x:208,y:181,size:7},{x:200,y:161,size:7},{x:181,y:153,size:7},{x:161,y:157,size:6},{x:145,y:168,size:6},{x:135,y:184,size:6},{x:131,y:202,size:6},{x:131,y:222,size:5},{x:139,y:240,size:5},{x:151,y:255,size:5},{x:166,y:267,size:5},{x:183,y:274,size:5},{x:202,y:276,size:5},{x:161,y:183,size:7},{x:153,y:202,size:7},{x:156,y:223,size:6},{x:167,y:239,size:6},{x:183,y:249,size:6},{x:202,y:253,size:6},{x:222,y:228,size:6},{x:238,y:217,size:6},{x:249,y:201,size:6},{x:252,y:182,size:6},{x:251,y:162,size:5},{x:244,y:145,size:5},{x:232,y:130,size:5},{x:217,y:118,size:5},{x:199,y:111,size:5},{x:181,y:109,size:5},{x:161,y:110,size:4},{x:144,y:116,size:4},{x:127,y:125,size:4},{x:114,y:136,size:4},{x:102,y:150,size:4},{x:94,y:166,size:4},{x:88,y:184,size:4},{x:86,y:202,size:4},{x:89,y:222,size:3},{x:94,y:239,size:3},{x:101,y:256,size:3},{x:110,y:271,size:3},{x:121,y:284,size:3},{x:135,y:295,size:3},{x:150,y:305,size:3},{x:166,y:312,size:3},{x:184,y:316,size:3},{x:202,y:317,size:3},{x:221,y:252,size:5},{x:239,y:245,size:5},{x:254,y:233,size:5},{x:266,y:218,size:5},{x:273,y:200,size:5},{x:275,y:182,size:5},{x:273,y:162,size:4},{x:267,y:145,size:4},{x:259,y:128,size:4},{x:246,y:114,size:4},{x:233,y:103,size:4},{x:217,y:94,size:4},{x:199,y:89,size:4},{x:181,y:87,size:4},{x:162,y:90,size:3},{x:145,y:94,size:3},{x:128,y:101,size:3},{x:113,y:111,size:3},{x:99,y:122,size:3},{x:89,y:135,size:3},{x:79,y:151,size:3},{x:72,y:166,size:3},{x:68,y:184,size:3},{x:67,y:202,size:3},{x:222,y:275,size:4},{x:239,y:269,size:4},{x:255,y:260,size:4},{x:269,y:248,size:4},{x:281,y:234,size:4},{x:290,y:218,size:4},{x:295,y:201,size:4},{x:297,y:182,size:4},{x:293,y:162,size:3},{x:289,y:145,size:3},{x:282,y:129,size:3},{x:272,y:114,size:3},{x:261,y:100,size:3},{x:248,y:89,size:3},{x:233,y:79,size:3},{x:216,y:73,size:3},{x:199,y:68,size:3},{x:181,y:67,size:3},{x:221,y:294,size:3},{x:202,y:298,size:4},{x:183,y:296,size:4},{x:166,y:290,size:4},{x:149,y:282,size:4},{x:135,y:270,size:4},{x:124,y:256,size:4},{x:115,y:240,size:4},{x:109,y:222,size:4},{x:107,y:202,size:5},{x:110,y:184,size:5},{x:117,y:166,size:5},{x:129,y:151,size:5},{x:144,y:140,size:5},{x:161,y:133,size:5},{x:180,y:132,size:6},{x:200,y:135,size:6},{x:215,y:146,size:6},{x:226,y:162,size:6},{x:231,y:182,size:7},{x:222,y:201,size:7},{x:239,y:290,size:3},{x:254,y:283,size:3},{x:270,y:274,size:3},{x:284,y:262,size:3},{x:295,y:249,size:3},{x:304,y:234,size:3},{x:311,y:218,size:3},{x:315,y:200,size:3},{x:316,y:182,size:3}],[{x:241,y:192,size:5},{x:232,y:214,size:5},{x:186,y:168,size:5},{x:209,y:159,size:5},{x:232,y:168,size:5},{x:274,y:192,size:5},{x:269,y:216,size:5},{x:255,y:237,size:5},{x:163,y:147,size:5},{x:184,y:132,size:5},{x:209,y:127,size:5},{x:233,y:132,size:5},{x:255,y:147,size:5},{x:269,y:166,size:5},{x:306,y:192,size:5},{x:302,y:216,size:5},{x:292,y:240,size:5},{x:278,y:260,size:5},{x:237,y:258,size:5},{x:260,y:280,size:5},{x:162,y:176,size:5},{x:138,y:166,size:5},{x:129,y:144,size:5},{x:186,y:203,size:5},{x:162,y:208,size:5},{x:136,y:203,size:5},{x:115,y:189,size:5},{x:102,y:168,size:5},{x:97,y:144,size:5},{x:102,y:119,size:5},{x:209,y:227,size:5},{x:186,y:237,size:5},{x:162,y:240,size:5},{x:136,y:237,size:5},{x:112,y:227,size:5},{x:93,y:211,size:5},{x:77,y:192,size:5},{x:68,y:168,size:5},{x:64,y:144,size:5},{x:68,y:118,size:5},{x:77,y:94,size:5},{x:116,y:103,size:5},{x:93,y:80,size:5},{x:135,y:88,size:5},{x:111,y:64,size:5},{x:141,y:123,size:5},{x:161,y:107,size:5},{x:184,y:98,size:5},{x:209,y:94,size:5},{x:234,y:98,size:5},{x:258,y:107,size:5},{x:278,y:123,size:5},{x:292,y:144,size:5},{x:302,y:166,size:5},{x:209,y:192,size:5}],[{x:188,y:188,size:8},{x:203,y:189,size:6},{x:193,y:203,size:6},{x:176,y:197,size:6},{x:176,y:180,size:6},{x:193,y:173,size:6},{x:220,y:190,size:5},{x:214,y:207,size:5},{x:199,y:218,size:5},{x:180,y:218,size:5},{x:164,y:207,size:5},{x:159,y:190,size:5},{x:164,y:171,size:5},{x:180,y:160,size:5},{x:199,y:160,size:5},{x:214,y:171,size:5},{x:236,y:191,size:3},{x:232,y:209,size:3},{x:221,y:225,size:3},{x:205,y:234,size:3},{x:185,y:236,size:3},{x:167,y:230,size:3},{x:153,y:217,size:3},{x:145,y:200,size:3},{x:145,y:181,size:3},{x:153,y:163,size:3},{x:167,y:150,size:3},{x:185,y:144,size:3},{x:205,y:146,size:3},{x:221,y:155,size:3},{x:232,y:172,size:3},{x:253,y:192,size:2},{x:250,y:210,size:2},{x:241,y:228,size:2},{x:228,y:241,size:2},{x:210,y:250,size:2},{x:192,y:253,size:2},{x:172,y:250,size:2},{x:155,y:241,size:2},{x:141,y:228,size:2},{x:133,y:210,size:2},{x:129,y:192,size:2},{x:133,y:172,size:2},{x:141,y:155,size:2},{x:155,y:141,size:2},{x:172,y:133,size:2},{x:192,y:129,size:2},{x:210,y:133,size:2},{x:228,y:141,size:2},{x:241,y:155,size:2},{x:250,y:172,size:2},{x:267,y:191,size:3},{x:264,y:209,size:3},{x:258,y:227,size:3},{x:246,y:243,size:3},{x:231,y:255,size:3},{x:214,y:264,size:3},{x:195,y:267,size:3},{x:175,y:266,size:3},{x:157,y:260,size:3},{x:141,y:249,size:3},{x:128,y:236,size:3},{x:118,y:218,size:3},{x:114,y:200,size:3},{x:114,y:181,size:3},{x:118,y:162,size:3},{x:128,y:145,size:3},{x:141,y:131,size:3},{x:157,y:121,size:3},{x:175,y:114,size:3},{x:195,y:113,size:3},{x:214,y:117,size:3},{x:231,y:125,size:3},{x:246,y:137,size:3},{x:258,y:153,size:3},{x:264,y:171,size:3},{x:281,y:190,size:5},{x:280,y:208,size:5},{x:273,y:226,size:5},{x:263,y:244,size:5},{x:251,y:258,size:5},{x:235,y:270,size:5},{x:218,y:277,size:5},{x:199,y:281,size:5},{x:180,y:281,size:5},{x:161,y:277,size:5},{x:143,y:270,size:5},{x:127,y:258,size:5},{x:115,y:244,size:5},{x:105,y:226,size:5},{x:98,y:208,size:5},{x:97,y:190,size:5},{x:98,y:170,size:5},{x:105,y:152,size:5},{x:115,y:135,size:5},{x:127,y:120,size:5},{x:143,y:109,size:5},{x:161,y:101,size:5},{x:180,y:98,size:5},{x:199,y:98,size:5},{x:218,y:101,size:5},{x:235,y:109,size:5},{x:251,y:120,size:5},{x:263,y:135,size:5},{x:273,y:152,size:5},{x:280,y:170,size:5},{x:296,y:189,size:6},{x:294,y:207,size:6},{x:289,y:226,size:6},{x:280,y:244,size:6},{x:270,y:259,size:6},{x:255,y:272,size:6},{x:239,y:283,size:6},{x:222,y:290,size:6},{x:203,y:295,size:6},{x:183,y:296,size:6},{x:164,y:293,size:6},{x:145,y:287,size:6},{x:129,y:278,size:6},{x:114,y:266,size:6},{x:101,y:251,size:6},{x:91,y:234,size:6},{x:84,y:217,size:6},{x:81,y:198,size:6},{x:81,y:179,size:6},{x:84,y:159,size:6},{x:91,y:142,size:6},{x:101,y:125,size:6},{x:114,y:110,size:6},{x:129,y:98,size:6},{x:145,y:89,size:6},{x:164,y:83,size:6},{x:183,y:80,size:6},{x:203,y:81,size:6},{x:222,y:86,size:6},{x:239,y:93,size:6},{x:255,y:104,size:6},{x:270,y:117,size:6},{x:280,y:133,size:6},{x:289,y:150,size:6},{x:294,y:169,size:6},{x:310,y:188,size:8},{x:308,y:206,size:8},{x:305,y:225,size:8},{x:297,y:243,size:8},{x:287,y:260,size:8},{x:274,y:274,size:8},{x:260,y:287,size:8},{x:243,y:297,size:8},{x:225,y:305,size:8},{x:206,y:308,size:8},{x:188,y:310,size:8},{x:168,y:308,size:8},{x:149,y:305,size:8},{x:132,y:297,size:8},{x:115,y:287,size:8},{x:100,y:274,size:8},{x:87,y:260,size:8},{x:78,y:243,size:8},{x:70,y:225,size:8},{x:66,y:206,size:8},{x:64,y:188,size:8},{x:66,y:168,size:8},{x:70,y:149,size:8},{x:78,y:132,size:8},{x:87,y:115,size:8},{x:100,y:100,size:8},{x:115,y:87,size:8},{x:132,y:78,size:8},{x:149,y:70,size:8},{x:168,y:66,size:8},{x:188,y:64,size:8},{x:206,y:66,size:8},{x:225,y:70,size:8},{x:243,y:78,size:8},{x:260,y:87,size:8},{x:274,y:100,size:8},{x:287,y:115,size:8},{x:297,y:132,size:8},{x:305,y:149,size:8},{x:308,y:168,size:8}],[{x:205,y:183,size:8},{x:174,y:200,size:8},{x:174,y:166,size:8},{x:225,y:183,size:8},{x:205,y:218,size:8},{x:164,y:218,size:8},{x:144,y:183,size:8},{x:164,y:148,size:8},{x:205,y:148,size:8},{x:245,y:183,size:8},{x:231,y:222,size:8},{x:195,y:242,size:8},{x:154,y:235,size:8},{x:128,y:204,size:8},{x:128,y:162,size:8},{x:154,y:131,size:8},{x:195,y:123,size:8},{x:231,y:144,size:8},{x:265,y:183,size:8},{x:254,y:223,size:8},{x:225,y:253,size:8},{x:185,y:264,size:8},{x:144,y:253,size:8},{x:115,y:223,size:8},{x:104,y:183,size:8},{x:115,y:143,size:8},{x:144,y:113,size:8},{x:185,y:102,size:8},{x:225,y:113,size:8},{x:254,y:143,size:8},{x:285,y:183,size:8},{x:277,y:224,size:8},{x:252,y:258,size:8},{x:216,y:279,size:8},{x:174,y:283,size:8},{x:134,y:270,size:8},{x:103,y:242,size:8},{x:86,y:204,size:8},{x:86,y:162,size:8},{x:103,y:124,size:8},{x:134,y:96,size:8},{x:174,y:83,size:8},{x:216,y:87,size:8},{x:252,y:108,size:8},{x:277,y:142,size:8},{x:305,y:183,size:8},{x:298,y:224,size:8},{x:277,y:261,size:8},{x:245,y:288,size:8},{x:206,y:302,size:8},{x:164,y:302,size:8},{x:124,y:288,size:8},{x:92,y:261,size:8},{x:71,y:224,size:8},{x:64,y:183,size:8},{x:71,y:142,size:8},{x:92,y:105,size:8},{x:124,y:78,size:8},{x:164,y:64,size:8},{x:206,y:64,size:8},{x:245,y:78,size:8},{x:277,y:105,size:8},{x:298,y:142,size:8},{x:185,y:183,size:8}]];

Pts.namespace(window);

// (Chrome) force window reset on reload.
window.onbeforeunload = function () { window.scrollTo(0, 0); }

let mql = matchMedia("(min-width: 1200px)"); // used to track when we switch between mobile/desktop views
let screenWeight; // keeps particle displacement even between mobile/desktop.
let objStream; // current array of particles

// Theme data:
const lightColor = '#4F4F4F';
const darkColor = '#FFFFFF';
const toggleButton = document.querySelector("[data-theme-toggle]");

window.addEventListener("resize", paint); // Repaint all canvases when window is resized.
paint(); // Initial paint

function paint() {  
  // Reset scroll position on page (re)paint.
  // There seems to be a pts.js bug where canvas height is calculated based on scroll position.
  // I don't think it's my fault since it's also happening on the official site demos.  
  window.scrollTo(0, 0);
    
  for (let i in objs) {
    // Configure space:
    let space = new CanvasSpace(`particles-${i}`).setup({
      bgcolor: "",
      resize: true,
    });
     
    // Dispose space when window is resized.
    window.addEventListener("resize", clearThisWindow);
    function clearThisWindow() {
      window.removeEventListener('resize', clearThisWindow);
      space.dispose();
    }

    // Freeze canvases when cursor is not present.
    const domCanvas = document.getElementById("particles-" + i);
    let isCanvasActive = false;

    domCanvas.addEventListener("pointerenter", function () {
      isCanvasActive = true;
      clearTimeout(freezeId);
      space.resume();
    });

    domCanvas.addEventListener("pointerleave", function () {
      isCanvasActive = false;
      freezeCanvas();
    });

    let freezeId;
    function freezeCanvas() {
      freezeId = setTimeout(() => {
        space.pause();
      }, 1000);
    }

    // Set up form:
    let form = space.getForm();
    let pts = [];

    space.add({
      start: () => {
        // Update particle positioning to match screen type.
        if (mql.matches) {
          objStream = offsetStream(objs[i], 0, 0, 1.5, 1.5, 1.5);
          screenWeight = 3;
        } else {
          objStream = offsetStream(objs[i], 0, 0, .8);
          screenWeight = 1.0;
        }

        // Format particle object for pts to use.
        pts = objStream
          .map((p) => (p = { pts: new Pt(p.x, p.y), size: p.size }))
          .map((p) => ({
            origin: p.pts.clone(),
            current: p.pts.clone(),
            velocity: new Pt(0, 0),
            size: p.size,
          }));

        toggleButton.addEventListener('click', () => fillParticles(pts));

        // Fill on page load/resize then pause canvas.
        fillParticles(pts);
        space.pause();
      },

      animate: (time, ftime) => {
        let r = 100;
        let range = Circle.fromCenter(space.pointer, r);

        fillParticles(pts);
        
        // Debugger:
        // form.log(`ms: ${ftime.toFixed(2)}     fps: ${Math.round(1000 / ftime)}     pointer: ${space.pointer}`);
        
        for (let i = 0; i < pts.length; i++) {
          let dir = pts[i].current.$subtract(space.pointer);
          let dist = dir.magnitude();

          if (Circle.withinBound(range, pts[i].current) && isCanvasActive) {
            let force = dir.unit().multiply((((r - dist) * 0.1) / pts[i].size) * screenWeight);
            pts[i].velocity.add(force);
          }

          let origin = pts[i].origin.$subtract(pts[i].current).multiply(0.05);
          pts[i].velocity.add(origin);

          pts[i].velocity.multiply(0.7);
          pts[i].current.add(pts[i].velocity);
        }
      },
    });
    space.play().bindMouse().bindTouch();


    function getTheme() {
      return document.querySelector('html').getAttribute('data-theme');
    }

    function fillParticles(pts) {
      space.clear();
      for (let i = 0; i < pts.length; i++) form.fillOnly(getTheme() === 'light' ? lightColor : darkColor).point(pts[i].current, pts[i].size, "circle");
    }
  }
}


function offsetStream(arr, offX, offY, size = 1, sizeXOffset = 1, sizeYOffset = 1) {
  let retArr = arr.map((p) => ({
    x: p.x * sizeXOffset + offX,
    y: p.y * sizeYOffset + offY,
    size: p.size * size,
  }));
  console.log(retArr);
  return retArr;
}